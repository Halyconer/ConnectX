<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect4 Game</title>
    <style>
        :root {
            --board-bg: #0066cc;
            --cell-bg: #f0f0f0;
            --player1-color: #ff4444;
            --player2-color: #ffdd44;
            --shadow-color: rgba(0,0,0,0.2);
        }

        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background-color: #f0f0f0;
        }
        
        .game-container {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 6px 12px var(--shadow-color);
        }
        
        .board-container {
            position: relative;
            margin: 20px 0;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(7, 60px);
            grid-template-rows: repeat(6, 60px);
            gap: 5px;
            background-color: var(--board-bg);
            padding: 10px;
            border-radius: 10px;
            z-index: 1;
        }

        .animation-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none; /* Allows clicks to go through to the board */
        }
        
        .cell {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #004499;
            cursor: pointer;
            background-color: var(--cell-bg);
            transition: background-color 0.3s;
        }
        
        .cell.player1 {
            background-color: var(--player1-color); /* fallback */
            background: radial-gradient(circle at 20px 20px, #ff7777, #ff4444);
            box-shadow: inset 0 -4px 4px rgba(0,0,0,0.2);
        }
        
        .cell.player2 {
            background-color: var(--player2-color); /* fallback */
            background: radial-gradient(circle at 20px 20px, #ffff77, #ffdd44);
            box-shadow: inset 0 -4px 4px rgba(0,0,0,0.2);
        }
        
        .cell:hover:not(.player1):not(.player2) {
            background-color: #e0e0e0;
        }
        
        .coin {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            transition: top 0.5s cubic-bezier(0.5, -0.5, 0.5, 1.5);
            box-shadow: inset 0 -4px 4px rgba(0,0,0,0.2), 0 4px 6px rgba(0,0,0,0.2);
        }

        .coin.player1 {
            background: radial-gradient(circle at 20px 20px, #ff7777, #ff4444);
        }

        .coin.player2 {
            background: radial-gradient(circle at 20px 20px, #ffff77, #ffdd44);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #0066cc;
            color: white;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #0052a3;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .status {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            min-height: 25px;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Connect4 vs AI</h1>
        
        <div class="status" id="status">Click "New Game" to start!</div>
        
        <div class="controls">
            <button id="newGameBtn" onclick="newGame()">New Game</button>
        </div>
        
        <div class="board-container">
            <div class="board" id="board"></div>
            <div class="animation-container" id="animation-container"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000'; 
        let gameState = null;
        let isProcessing = false;

        function createBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for (let row = 5; row >= 0; row--) {
                for (let col = 0; col < 7; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.onclick = () => makeMove(col);
                    board.appendChild(cell);
                }
            }
        }

        function updateBoard() {
            if (!gameState) return;
            
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const row = parseInt(cell.dataset.row); 
                const col = parseInt(cell.dataset.col);
                const piece = gameState.board[row][col];
                
                cell.className = 'cell';
                if (piece === 1) cell.classList.add('player1');
                if (piece === 2) cell.classList.add('player2');
            });
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (data) options.body = JSON.stringify(data);
                
                const response = await fetch(API_BASE + endpoint, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                updateStatus('Connection error! Make sure Flask server is running.');
                return null;
            }
        }

        async function newGame() {
            isProcessing = true;
            updateStatus('Starting new game...');
            
            const response = await apiRequest('/play', 'POST');
            if (response) {
                gameState = response;
                createBoard();
                updateBoard();
                updateStatus('Your turn! Click a column to drop your piece.');
            } else {
                updateStatus('Failed to start new game.');
            }
            isProcessing = false;
        }

        function animateDrop(col, row, player) {
            return new Promise(resolve => {
                const animationContainer = document.getElementById('animation-container');
                const coin = document.createElement('div');
                coin.className = `coin ${player}`;

                // Calculate starting and ending positions with the corrected offset
                const startLeft = (60 + 5) * col + 2; // Corrected offset
                const startTop = -60; // Start above the board
                const endTop = (60 + 5) * (5 - row) + 2; // Corrected offset

                coin.style.left = `${startLeft}px`;
                coin.style.top = `${startTop}px`;

                animationContainer.appendChild(coin);

                // Force a reflow to apply initial styles before animating
                requestAnimationFrame(() => {
                    coin.style.top = `${endTop}px`;
                });

                coin.addEventListener('transitionend', () => {
                    animationContainer.innerHTML = ''; // Clear animation
                    resolve();
                }, { once: true });
            });
        }

        function findDropRow(board, col) {
            for (let r = 0; r < 6; r++) {
                if (board[r][col] !== 0) {
                    return r;
                }
            }
            return -1; // Should not happen in valid moves
        }

        async function makeMove(col) {
            if (isProcessing || !gameState || gameState.game_over) return;

            const validCols = gameState.valid_cols || [];
            if (!validCols.includes(col)) {
                updateStatus('Invalid move! Column is full.');
                return;
            }
            
            isProcessing = true;
            updateStatus('Processing move...');
            
            const oldBoard = gameState.board;
            const response = await apiRequest('/move', 'POST', { column: col }); 
            
            if (response) {
                // Player's move animation
                const playerRow = findDropRow(response.board_before_ai, col);
                await animateDrop(col, playerRow, 'player1');
                gameState.board = response.board_before_ai;
                updateBoard();

                if (response.game_over) {
                    if (response.winner === 'player') {
                        updateStatus('ðŸŽ‰ You won! Great job!');
                    } else {
                        updateStatus('Game over!');
                    }
                    isProcessing = false;
                    return;
                }

                updateStatus('AI is thinking...');

                // AI's move animation
                if (response.ai_move !== null) {
                    const aiCol = response.ai_move;
                    const aiRow = findDropRow(response.board_after_ai, aiCol);
                    
                    setTimeout(async () => {
                        await animateDrop(aiCol, aiRow, 'player2');
                        gameState.board = response.board_after_ai;
                        updateBoard();

                        if (response.game_over && response.winner === 'ai') {
                            updateStatus('ðŸ¤– AI wins! Try again?');
                        } else {
                            updateStatus(`AI dropped in column ${aiCol + 1}. Your turn!`);
                        }
                        isProcessing = false;
                    }, 500); // Delay before AI drops
                } else {
                    isProcessing = false;
                }
            } else {
                isProcessing = false;
            }
        }

        // Initialize
        newGame();
    </script>
</body>
</html>